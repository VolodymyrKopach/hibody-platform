# üé® –ï—Ç–∞–ø 1: –î–æ–¥–∞–≤–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó - –ü–û–í–ù–Ü–°–¢–Æ –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

## üìã –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —ñ –ø—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ

### ‚úÖ **1. –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è Claude –ø—Ä–æ–º–ø—Ç—É**
**–§–∞–π–ª:** `src/services/content/ClaudeSonnetContentService.ts`
- –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è IMAGE_PROMPT –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
- –§–æ—Ä–º–∞—Ç: `<!-- IMAGE_PROMPT: "–æ–ø–∏—Å –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é" WIDTH: 512 HEIGHT: 384 -->`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è FLUX API (—Ä–æ–∑–º—ñ—Ä–∏ –∫—Ä–∞—Ç–Ω—ñ 16, –∞–Ω–≥–ª—ñ–π—Å—å–∫—ñ –ø—Ä–æ–º–ø—Ç–∏)

### ‚úÖ **2. –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–æ–±–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å**
**–§–∞–π–ª:** `src/utils/slideImageProcessor.ts`
- `extractImagePrompts()` - –ø–∞—Ä—Å–∏–Ω–≥ HTML –∑ regex
- `validateAndFixDimensions()` - –∞–≤—Ç–æ–∫–æ—Ä–µ–∫—Ü—ñ—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ (–º—ñ–Ω: 128px, –º–∞–∫—Å: 1536px, –∫—Ä–∞—Ç–Ω–æ 16)
- `generateAllImages()` - –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ FLUX API
- `replaceImageComments()` - –∑–∞–º—ñ–Ω–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ –Ω–∞ `<img>` –∑ base64
- `processSlideWithImages()` - –æ—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏

### ‚úÖ **3. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é —Å–ª–∞–π–¥—ñ–≤**
**–§–∞–π–ª:** `src/services/content/ClaudeSonnetContentService.ts`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø—ñ—Å–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó HTML
- –ú–µ—Ç–∞–¥–∞–Ω—ñ –ø—Ä–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ —Ç–∏–ø–∞—Ö
- Fallback placeholder –¥–ª—è –Ω–µ–≤–¥–∞–ª–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü—ñ–π

### ‚úÖ **4. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è URL –ø—Ä–æ–±–ª–µ–º**
**–§–∞–π–ª:** `src/utils/imageGeneration.ts`
- –î–∏–Ω–∞–º—ñ—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –±–∞–∑–æ–≤–æ–≥–æ URL (client/server)
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ—ó —Ä–æ–∑—Ä–æ–±–∫–∏ —Ç–∞ production
- –õ–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –¥–ª—è –¥–µ–±–∞–≥—É

### ‚úÖ **5. –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è —Ç–∏–ø—ñ–≤**
**–§–∞–π–ª:** `src/types/lesson.ts`
- `SlideImageInfo` - –º–µ—Ç–∞–¥–∞–Ω—ñ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö –∑–æ–±—Ä–∞–∂–µ–Ω—å
- –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ `LessonSlide` —Å—Ç—Ä—É–∫—Ç—É—Ä—É

## üî• **–¢–µ—Ö–Ω—ñ—á–Ω—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ**

### –£–º–æ–≤–∞ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
Claude **–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ** –¥–æ–¥–∞—î IMAGE_PROMPT –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –≤ HTML –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –±—É–¥—å-—è–∫–æ–≥–æ —Å–ª–∞–π–¥—É.

### –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞
```typescript
// –í—Å—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ
const imageResults = await Promise.all(
  imagePrompts.map(promptData => generateImage(request))
);
```

### Smart –∫–æ—Ä–µ–∫—Ü—ñ—è —Ä–æ–∑–º—ñ—Ä—ñ–≤
```typescript
// –ê–≤—Ç–æ–∫–æ—Ä–µ–∫—Ü—ñ—è: 128x96 ‚Üí 128x96 (ok)
// –ê–≤—Ç–æ–∫–æ—Ä–µ–∫—Ü—ñ—è: 100x100 ‚Üí 112x112 (–∫—Ä–∞—Ç–Ω–æ 16)
// –ê–≤—Ç–æ–∫–æ—Ä–µ–∫—Ü—ñ—è: 2000x500 ‚Üí 1536x512 (–≤ –º–µ–∂–∞—Ö –ª—ñ–º—ñ—Ç—ñ–≤)
```

### Base64 —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è
```html
<img src="data:image/webp;base64,UklGRv..." 
     width="512" height="384" 
     alt="Generated image" 
     style="border-radius: 8px;" />
```

## üß™ **–ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ**

### ‚úÖ –£—Å–ø—ñ—à–Ω—ñ —Ç–µ—Å—Ç–∏
1. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —É—Ä–æ–∫—É**: `POST /api/chat` ‚úÖ
2. **–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–ª–∞–π–¥—ñ–≤ –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º–∏**: ‚úÖ
3. **–ê–≤—Ç–æ–∫–æ—Ä–µ–∫—Ü—ñ—è —Ä–æ–∑–º—ñ—Ä—ñ–≤**: `128x96 ‚Üí 128x96` ‚úÖ
4. **–ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è**: Multiple images ‚úÖ
5. **Base64 —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è**: HTML –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º–∏ ‚úÖ
6. **Fallback —Å–∏—Å—Ç–µ–º–∞**: Placeholder –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö ‚úÖ

### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑ –ª–æ–≥—ñ–≤
```
üéØ Generating slide HTML with Claude...
‚úÖ Base slide HTML generated, length: 17851
üé® Processing images in slide...
üîß Auto-correcting to: 128x128
üîç Found 1 image prompts in HTML
üöÄ Starting parallel generation of 1 images...
üì∏ [1/1] Generating: "A friendly cartoon..."
üîó Generating image via: http://localhost:3000/api/images
‚úÖ Slide image processing completed
‚úÖ Final slide with images ready, length: 18069
```

## üéØ **–ì–æ—Ç–æ–≤–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –µ—Ç–∞–ø—É**

### –©–æ –ø—Ä–∞—Ü—é—î
- ‚úÖ Claude –≥–µ–Ω–µ—Ä—É—î HTML –∑ IMAGE_PROMPT –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏
- ‚úÖ Regex –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
- ‚úÖ –ê–≤—Ç–æ–∫–æ—Ä–µ–∫—Ü—ñ—è —Ä–æ–∑–º—ñ—Ä—ñ–≤ –¥–ª—è FLUX
- ‚úÖ –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
- ‚úÖ Base64 —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ HTML
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è

### –ì–æ—Ç–æ–≤–æ –¥–ª—è –µ—Ç–∞–ø—É 2
1. **–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è** - –∫–µ—à—É–≤–∞–Ω–Ω—è, —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è
2. **UI –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è** - preview, progress bars
3. **–†–æ–∑—à–∏—Ä–µ–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ** - —Å—Ç–∏–ª—ñ, –µ—Ñ–µ–∫—Ç–∏
4. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ**

## üöÄ **–ö–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è**

```bash
# –°—Ç–≤–æ—Ä–∏—Ç–∏ —É—Ä–æ–∫ –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º–∏
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"–°—Ç–≤–æ—Ä–∏ —É—Ä–æ–∫ –ø—Ä–æ –∫–æ—Ç–∞ —è–∫–∏–π –Ω–∞–≤—á–∞—î –¥—ñ—Ç–µ–π –º–∞—Ç–µ–º–∞—Ç–∏—Ü—ñ –¥–ª—è –¥—ñ—Ç–µ–π 6-8 —Ä–æ–∫—ñ–≤"}'

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω—å
curl ... | jq -r '.lesson.slideHtmlPreview' | grep -E "(data:image|<img)"
```

---

**–°—Ç–∞—Ç—É—Å: üéâ –ï–¢–ê–ü 1 –ü–û–í–ù–Ü–°–¢–Æ –ó–ê–í–ï–†–®–ï–ù–û**

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó –ø—Ä–∞—Ü—é—î —Å—Ç–∞–±—ñ–ª—å–Ω–æ —ñ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è! 