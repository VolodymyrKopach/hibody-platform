# База даних TeachSpark Platform

Цей документ містить інструкції для налаштування бази даних Supabase для проекту TeachSpark Platform.

## Структура бази даних

### Основні таблиці:

1. **user_profiles** - розширені профілі користувачів
2. **lessons** - уроки, створені користувачами
3. **slides** - слайди в межах уроків
4. **slide_images** - зображення для слайдів
5. **chat_sessions** - сесії чату з AI
6. **chat_messages** - повідомлення в чаті
7. **subscription_usage** - відстеження використання ресурсів
8. **lesson_shares** - публічний доступ до уроків
9. **lesson_ratings** - рейтинги уроків

## Налаштування

### Крок 1: Створення проекту в Supabase

1. Перейдіть на [supabase.com](https://supabase.com)
2. Створіть новий проект
3. Скопіюйте URL та API ключі

### Крок 2: Налаштування змінних середовища

Створіть файл `.env.local` в корені проекту:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### Крок 3: Виконання міграцій

1. Відкрийте SQL Editor в Supabase Dashboard
2. Виконайте файли міграцій у правильному порядку:

#### 1. Основна схема
```sql
-- Скопіюйте та виконайте вміст файлу: migrations/001_initial_schema.sql
```

#### 2. RLS політики
```sql
-- Скопіюйте та виконайте вміст файлу: migrations/002_rls_policies.sql
```

### Крок 4: Налаштування Storage (опціонально)

Для зберігання зображень створіть bucket в Storage:

1. Перейдіть в Storage → Create bucket
2. Назвіть bucket `lesson-images`
3. Зробіть його публічним
4. Налаштуйте політики доступу

## Особливості архітектури

### Row Level Security (RLS)

Всі таблиці захищені RLS політиками, які забезпечують:
- Користувачі бачать тільки свої дані
- Публічні уроки доступні всім для перегляду
- Адміністратори мають повний доступ

### Автоматичні тригери

1. **Створення профілю** - автоматично створюється при реєстрації
2. **Оновлення updated_at** - автоматично оновлюється при змінах
3. **Рейтинг уроків** - автоматично перераховується при додаванні/видаленні оцінок

### Індекси

Створені індекси для оптимізації:
- Пошук уроків за користувачем, статусом, предметом
- Сортування за датою створення
- Швидкий доступ до слайдів та повідомлень

## Типи підписок

### Free (Безкоштовна)
- 5 уроків максимум
- 10 слайдів на урок
- 50 AI запитів на місяць
- 20 генерацій зображень

### Professional (Професійна)
- 50 уроків максимум
- 50 слайдів на урок
- 500 AI запитів на місяць
- 200 генерацій зображень
- Експорт уроків
- Публічні уроки

### Premium (Преміум)
- Необмежена кількість уроків і слайдів
- Необмежені AI запити та генерації
- Всі функції Professional

## Моніторинг використання

Таблиця `subscription_usage` відстежує:
- Кількість AI запитів
- Кількість генерацій зображень
- Створені уроки та слайди
- Період використання (місячний)

## Безпека

### Аутентифікація
- Використовується Supabase Auth
- Підтримка email/password
- Можна додати OAuth провайдерів

### Авторизація
- RLS політики на рівні бази даних
- Перевірка прав доступу для кожної операції
- Захист від несанкціонованого доступу

## Резервне копіювання

Рекомендується:
1. Налаштувати автоматичні бекапи в Supabase
2. Експортувати схему бази даних регулярно
3. Тестувати відновлення з бекапів

## Масштабування

При зростанні навантаження:
1. Моніторити продуктивність запитів
2. Додавати індекси за потребою
3. Розглянути партиціонування великих таблиць
4. Оптимізувати RLS політики

## Troubleshooting

### Часті проблеми:

1. **RLS блокує запити**
   - Перевірте, чи користувач аутентифікований
   - Перевірте політики доступу

2. **Повільні запити**
   - Перевірте план виконання запиту
   - Додайте необхідні індекси

3. **Помилки при створенні профілю**
   - Перевірте тригер `on_auth_user_created`
   - Перевірте права доступу функції

## Контакти

При виникненні питань звертайтеся до команди розробки. 