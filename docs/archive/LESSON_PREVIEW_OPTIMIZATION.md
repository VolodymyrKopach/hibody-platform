# –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –ø—Ä–µ–≤—å—é —É—Ä–æ–∫—ñ–≤ - —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

## üéØ –ó–∞–≤–¥–∞–Ω–Ω—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ —É—Ä–æ–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª–∏—Å—è –í–°–Ü thumbnail'–∏ —Å–ª–∞–π–¥—ñ–≤ –≤ Supabase Storage, —â–æ –±—É–ª–æ –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.

**–†—ñ—à–µ–Ω–Ω—è:** –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –û–î–ò–ù –≤–∏–±—Ä–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º thumbnail —è–∫ –ø—Ä–µ–≤—å—é —É—Ä–æ–∫—É.

## ‚úÖ –©–æ –∑—Ä–æ–±–ª–µ–Ω–æ

### 1. **–û–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è**
```typescript
// –ë—É–ª–æ: –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ thumbnail'–∏
const storageUrls = await localThumbnailStorage.uploadAllToStorage(lessonId, selectedSlideIds);

// –°—Ç–∞–ª–æ: –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –≤–∏–±—Ä–∞–Ω–∏–π
if (dialogData.selectedPreviewId && dialogData.previewUrl) {
  const lessonThumbnailUrl = await localThumbnailStorage.uploadToStorage(
    dialogData.selectedPreviewId, 
    lessonId
  );
}
```

### 2. **–û–Ω–æ–≤–ª–µ–Ω–∏–π API –∑–∞–ø–∏—Ç**
```typescript
// –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ thumbnail_url —É—Ä–æ–∫—É
const response = await fetch('/api/lessons', {
  method: 'POST',
  body: JSON.stringify({
    title: dialogData.title,
    thumbnail_url: lessonThumbnailUrl, // ‚úÖ –¢—ñ–ª—å–∫–∏ –≤–∏–±—Ä–∞–Ω–∏–π –ø—Ä–µ–≤—å—é
    slides: selectedSlideIds.map(slideId => ({
      // –±–µ–∑ thumbnailUrl –¥–ª—è —Å–ª–∞–π–¥—ñ–≤
    }))
  })
});
```

### 3. **–í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏ Storage**
```sql
-- –ù–æ–≤—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å lesson-thumbnails/ —Ç–∞ lessons/
CREATE POLICY "Users can upload lesson assets" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'lesson-assets' AND (
    auth.uid()::text = (storage.foldername(name))[1] OR
    (storage.foldername(name))[1] = 'lesson-thumbnails' OR
    (storage.foldername(name))[1] = 'lessons'
  )
);
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

### **–ï–∫–æ–Ω–æ–º—ñ—è Storage:**
- **–ë—É–ª–æ:** 5 —Å–ª–∞–π–¥—ñ–≤ √ó 200KB = 1MB –Ω–∞ —É—Ä–æ–∫
- **–°—Ç–∞–ª–æ:** 1 –ø—Ä–µ–≤—å—é √ó 200KB = 200KB –Ω–∞ —É—Ä–æ–∫  
- **–ï–∫–æ–Ω–æ–º—ñ—è:** 80% –º—ñ—Å—Ü—è –≤ Storage

### **–®–≤–∏–¥–∫—ñ—Å—Ç—å:**
- **–ë—É–ª–æ:** 5 API –≤–∏–∫–ª–∏–∫—ñ–≤ –¥–æ Storage
- **–°—Ç–∞–ª–æ:** 1 API –≤–∏–∫–ª–∏–∫ –¥–æ Storage
- **–®–≤–∏–¥–∫—ñ—Å—Ç—å:** –í 5 —Ä–∞–∑—ñ–≤ —à–≤–∏–¥—à–µ

### **UX:**
- **–ë—É–ª–æ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä –ø—Ä–µ–≤—å—é
- **–°—Ç–∞–ª–æ:** –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∞–º –æ–±–∏—Ä–∞—î –Ω–∞–π–∫—Ä–∞—â–∏–π –ø—Ä–µ–≤—å—é
- **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–µ–≤—å—é —É—Ä–æ–∫—É

## üîÑ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

### 1. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ª–∞–π–¥—ñ–≤**
```
–ß–∞—Ç ‚Üí AI —Å—Ç–≤–æ—Ä—é—î —Å–ª–∞–π–¥–∏ ‚Üí Thumbnail'–∏ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–≤ –ø–∞–º'—è—Ç—ñ)
```

### 2. **–í–∏–±—ñ—Ä –ø—Ä–µ–≤—å—é**
```
SaveLessonDialog ‚Üí PreviewSelector ‚Üí –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î ‚Üê‚Üí ‚Üí –û–±–∏—Ä–∞—î –ø—Ä–µ–≤—å—é
```

### 3. **–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è**
```
–ó–±–µ—Ä–µ–≥—Ç–∏ —É—Ä–æ–∫ ‚Üí –¢—ñ–ª—å–∫–∏ –≤–∏–±—Ä–∞–Ω–∏–π thumbnail –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –≤ Storage ‚Üí lesson.thumbnail_url
```

## üìÅ –§–∞–π–ª–∏ —â–æ –∑–º—ñ–Ω–∏–ª–∏—Å—è

### **–û—Å–Ω–æ–≤–Ω—ñ –∑–º—ñ–Ω–∏:**
1. `src/hooks/useSlideManagement.ts` - –Ω–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
2. `supabase/migrations/20250131000002_fix_storage_rls_policies.sql` - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏

### **–§–∞–π–ª–∏ —â–æ –∑–∞–ª–∏—à–∏–ª–∏—Å—å –±–µ–∑ –∑–º—ñ–Ω:**
1. `src/components/dialogs/SaveLessonDialog.tsx` - –ø—Ä–∞—Ü—é—î —è–∫ —Ä–∞–Ω—ñ—à–µ
2. `src/components/PreviewSelector.tsx` - –ø—Ä–∞—Ü—é—î —è–∫ —Ä–∞–Ω—ñ—à–µ
3. `src/services/slides/LocalThumbnailService.ts` - –º–µ—Ç–æ–¥ uploadToStorage –≤–∂–µ —ñ—Å–Ω—É–≤–∞–≤
4. `src/app/api/lessons/route.ts` - –≤–∂–µ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–≤ thumbnail_url

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —â–æ –≤—Å–µ –ø—Ä–∞—Ü—é—î:

1. **–°—Ç–≤–æ—Ä—ñ—Ç—å —É—Ä–æ–∫ –∑ –¥–µ–∫—ñ–ª—å–∫–æ–º–∞ —Å–ª–∞–π–¥–∞–º–∏**
2. **–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–±–µ—Ä–µ–≥—Ç–∏ —É—Ä–æ–∫"**
3. **–í PreviewSelector –ø–æ–∫–ª–∏–∫–∞–π—Ç–µ —Å—Ç—Ä—ñ–ª–æ—á–∫–∏ ‚Üê‚Üí –¥–ª—è –≤–∏–±–æ—Ä—É –ø—Ä–µ–≤—å—é**
4. **–ó–±–µ—Ä–µ–∂—ñ—Ç—å —É—Ä–æ–∫**
5. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –≤ Supabase Storage –∑–±–µ—Ä–µ–∂–µ–Ω–æ —Ç—ñ–ª—å–∫–∏ 1 —Ñ–∞–π–ª**
6. **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –≤ Materials –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –≤–∏–±—Ä–∞–Ω–∏–π –ø—Ä–µ–≤—å—é**

## üéØ –ü–µ—Ä–µ–≤–∞–≥–∏

‚úÖ **–ï–∫–æ–Ω–æ–º—ñ—è –∫–æ—à—Ç—ñ–≤** - 80% –º–µ–Ω—à–µ Storage  
‚úÖ **–®–≤–∏–¥–∫—ñ—Å—Ç—å** - 5√ó —à–≤–∏–¥—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è  
‚úÖ **UX** - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–æ–Ω—Ç—Ä–æ–ª—é—î –ø—Ä–µ–≤—å—é  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –æ–¥–∏–Ω –ø—Ä–µ–≤—å—é –Ω–∞ —É—Ä–æ–∫  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å** - –º–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ Storage  

## üîß –õ–æ–≥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

–®—É–∫–∞–π—Ç–µ —Ü—ñ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ:
```
‚òÅÔ∏è NEW SAVE: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–∏–±—Ä–∞–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é –≤ Storage: slide_abc123
üìä NEW SAVE: –ü—Ä–µ–≤—å—é —É—Ä–æ–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: https://supabase.../lesson_123_timestamp.png
üéØ NEW SAVE: –í–∏–±—Ä–∞–Ω–∏–π –ø—Ä–µ–≤—å—é: { slideId: "slide_abc123", storageUrl: "..." }
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û**  
**–î–∞—Ç–∞:** 31 —Å—ñ—á–Ω—è 2025  
**–ï–∫–æ–Ω–æ–º—ñ—è Storage:** 80%  
**–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ:** 5√ó 