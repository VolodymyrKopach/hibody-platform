# –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è RLS –ø–æ–ª—ñ—Ç–∏–∫ Supabase Storage

## üö® –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –ø—Ä–µ–≤—å—é —Å–ª–∞–π–¥—ñ–≤ –≤ Supabase Storage –≤–∏–Ω–∏–∫–∞—î –ø–æ–º–∏–ª–∫–∞:

```json
{
    "statusCode": "403",
    "error": "Unauthorized", 
    "message": "new row violates row-level security policy"
}
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

RLS –ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è Storage bucket `lesson-assets` –æ—á—ñ–∫—É–≤–∞–ª–∏, —â–æ –ø–µ—Ä—à–∞ –ø–∞–ø–∫–∞ –≤ —à–ª—è—Ö—É —Ñ–∞–π–ª—É –±—É–¥–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ `auth.uid()`:

```sql
-- –°—Ç–∞—Ä–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞ (‚ùå –ù–µ –ø—Ä–∞—Ü—é—î)
CREATE POLICY "Users can upload their own lesson assets" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'lesson-assets' AND 
  auth.uid()::text = (storage.foldername(name))[1]  -- –û—á—ñ–∫—É—î user_id/...
);
```

–ê–ª–µ –≤ –∫–æ–¥—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è —ñ–Ω—à—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø–∞–ø–æ–∫:
- `lesson-thumbnails/{lessonId}/{fileName}` - –≤ API route
- `lessons/{lessonId}/thumbnails/{fileName}` - –≤ LocalThumbnailService

## üõ†Ô∏è –†—ñ—à–µ–Ω–Ω—è

–û–Ω–æ–≤–ª–µ–Ω–æ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Ä—ñ–∑–Ω–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –ø–∞–ø–æ–∫:

```sql
-- –ù–æ–≤–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞ (‚úÖ –ü—Ä–∞—Ü—é—î)
CREATE POLICY "Users can upload lesson assets" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'lesson-assets' AND (
    -- –í–ª–∞—Å–Ω—ñ —Ñ–∞–π–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: user_id/...
    auth.uid()::text = (storage.foldername(name))[1] OR
    -- Thumbnail'–∏ —É—Ä–æ–∫—ñ–≤: lesson-thumbnails/...
    (storage.foldername(name))[1] = 'lesson-thumbnails' OR
    -- –§–∞–π–ª–∏ —É—Ä–æ–∫—ñ–≤: lessons/...
    (storage.foldername(name))[1] = 'lessons'
  )
);
```

## üìÅ –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø–∞–ø–æ–∫

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ —Ñ–∞–π–ª–∏ –≤:

1. **–í–ª–∞—Å–Ω—ñ –ø–∞–ø–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:**
   ```
   {user_id}/documents/file.pdf
   {user_id}/images/avatar.jpg
   ```

2. **Thumbnail'–∏ —É—Ä–æ–∫—ñ–≤ (API route):**
   ```
   lesson-thumbnails/{lessonId}/slide-1-preview-123456.png
   lesson-thumbnails/{lessonId}/slide-2-preview-123457.png
   ```

3. **–§–∞–π–ª–∏ —É—Ä–æ–∫—ñ–≤ (LocalThumbnailService):**
   ```
   lessons/{lessonId}/thumbnails/slide_123_456789.png
   lessons/{lessonId}/images/background.jpg
   ```

## üöÄ –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### –í–∞—Ä—ñ–∞–Ω—Ç 1: SQL —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
```bash
# –°–∫–æ–ø—ñ—é–π—Ç–µ –≤–º—ñ—Å—Ç scripts/fix-storage-rls.sql
# –í–∏–∫–æ–Ω–∞–π—Ç–µ –≤ SQL Editor Supabase Dashboard
```

### –í–∞—Ä—ñ–∞–Ω—Ç 2: –ú—ñ–≥—Ä–∞—Ü—ñ—è Supabase CLI
```bash
# –Ø–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ Supabase CLI
npx supabase db push
```

### –í–∞—Ä—ñ–∞–Ω—Ç 3: Node.js —Å–∫—Ä–∏–ø—Ç
```bash
# –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
export NEXT_PUBLIC_SUPABASE_URL="your-url"
export SUPABASE_SERVICE_ROLE_KEY="your-service-key"

# –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç
node scripts/apply-storage-fix.js
```

## ‚úÖ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

–ü—ñ—Å–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

1. **–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Å–ª–∞–π–¥—É**
   - –í—ñ–¥–∫—Ä–∏–π—Ç–µ —á–∞—Ç
   - –°—Ç–≤–æ—Ä—ñ—Ç—å —Å–ª–∞–π–¥
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –ø—Ä–µ–≤—å—é –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è

2. **–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó**
   - –í–∏–±–µ—Ä—ñ—Ç—å —Å–ª–∞–π–¥–∏ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
   - –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é"
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ thumbnail'–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –≤ Storage

3. **–ü–µ—Ä–µ–≥–ª—è–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —É—Ä–æ–∫—ñ–≤**
   - –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Ä–æ–∑–¥—ñ–ª "–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏"
   - –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ —É—Ä–æ–∫–∏ –º–∞—é—Ç—å thumbnail'–∏

## üîß –§–∞–π–ª–∏ —è–∫—ñ –±—É–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ

1. **supabase/migrations/20250131000001_create_storage_bucket.sql**
   - –û–Ω–æ–≤–ª–µ–Ω–æ RLS –ø–æ–ª—ñ—Ç–∏–∫–∏

2. **supabase/migrations/20250131000002_fix_storage_rls_policies.sql**
   - –ù–æ–≤–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º–∏

3. **scripts/fix-storage-rls.sql**
   - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä—è–º–æ–≥–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è

4. **scripts/apply-storage-fix.js**
   - Node.js —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è

## üìã –î–µ—Ç–∞–ª—ñ –ø–æ–ª—ñ—Ç–∏–∫

### –ü–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (INSERT)
- –î–æ–∑–≤–æ–ª—è—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤ `{user_id}/`, `lesson-thumbnails/`, `lessons/`

### –ü–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É (SELECT)  
- –î–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–≥–ª—è–¥ —Ñ–∞–π–ª—ñ–≤ –∑ —Ç–∏—Ö –∂–µ –ø–∞–ø–æ–∫
- –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø—É–±–ª—ñ—á–Ω–∞ –ø–æ–ª—ñ—Ç–∏–∫–∞ –¥–ª—è lesson-thumbnails —Ç–∞ lessons

### –ü–æ–ª—ñ—Ç–∏–∫–∏ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è (UPDATE/DELETE)
- –î–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω—É —Ñ–∞–π–ª—ñ–≤ –∑ —Ç–∏—Ö –∂–µ –ø–∞–ø–æ–∫

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–º–∏–ª–∫–∞ 403 –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—ñ–≤  
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–µ–≤—å—é —Å–ª–∞–π–¥—ñ–≤ –ø—Ä–∞—Ü—é—î  
‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ–π –∑ thumbnail'–∞–º–∏ –ø—Ä–∞—Ü—é—î  
‚úÖ –ü–µ—Ä–µ–≥–ª—è–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –ø—Ä–∞—Ü—é—î  

## üîÑ –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–≤–æ—Ä–æ—Ç–Ω—å–æ-—Å—É–º—ñ—Å–Ω–µ:
- –Ü—Å–Ω—É—é—á—ñ —Ñ–∞–π–ª–∏ –ø—Ä–æ–¥–æ–≤–∂–∞—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏
- –°—Ç–∞—Ä—ñ —à–ª—è—Ö–∏ —Ñ–∞–π–ª—ñ–≤ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è
- –ù–æ–≤—ñ —à–ª—è—Ö–∏ —Ñ–∞–π–ª—ñ–≤ —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—é—Ç—å 