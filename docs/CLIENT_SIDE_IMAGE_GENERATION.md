# Client-Side Image Generation for Worksheets

## üìã Overview

This system enables **direct client-side image generation** for worksheet components using Flux API. Images are generated in the browser after content generation, providing visual feedback and progress tracking.

‚ö†Ô∏è **Security Note:** This approach exposes API keys to the client. Use only for internal tools or trusted environments.

---

## üèóÔ∏è Architecture

### Two-Stage Generation Process

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    STAGE 1: CONTENT                         ‚îÇ
‚îÇ                    (Backend + Gemini)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚îÇ Returns worksheet with imagePrompts
                       ‚îÇ
                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    STAGE 2: IMAGES                          ‚îÇ
‚îÇ                    (Frontend + Flux API)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flow Diagram

```
User Input
    ‚Üì
Backend API (/api/worksheet/generate)
    ‚Üì
Gemini 2.5 Flash
    ‚Üì
Returns: {
  pages: [
    {
      elements: [
        {
          type: "image-placeholder",
          properties: {
            imagePrompt: "A friendly T-Rex dinosaur...",  ‚Üê Generated by Gemini
            caption: "Dinosaur",
            width: 400,
            height: 300
          }
        }
      ]
    }
  ]
}
    ‚Üì
Frontend (WorksheetEditor)
    ‚Üì
WorksheetImageGenerationService
    ‚Üì
For each image-placeholder with imagePrompt:
    ‚Üì
Direct HTTPS Request to Flux API
    ‚Üì
Returns: base64 image
    ‚Üì
Updates element.properties.url
    ‚Üì
Display in Canvas
```

---

## üîë Key Components

### 1. Component Schema Update

**File:** `src/services/worksheet/WorksheetComponentSchemaService.ts`

```typescript
properties: {
  imagePrompt: {
    type: 'string',
    required: false,
    description: 'Prompt for AI image generation (Flux)',
    examples: [
      'A friendly T-Rex dinosaur in prehistoric forest, educational illustration',
    ],
  },
  url: {
    type: 'string',
    required: false,
    description: 'Image URL (leave empty when using imagePrompt)',
  },
  // ... other properties
}
```

**Purpose:** Tell Gemini to generate `imagePrompt` instead of `url` for image components.

---

### 2. Gemini Prompt Enhancement

**File:** `src/services/worksheet/GeminiWorksheetGenerationService.ts`

```typescript
# CRITICAL RULES
9. **Images (IMPORTANT):** When using image-placeholder, 
   ALWAYS provide "imagePrompt" instead of "url". 
   The imagePrompt should be detailed, child-friendly description.
   DO NOT provide url field when using imagePrompt.
```

**Purpose:** Instruct Gemini to generate prompts for Flux, not URLs.

---

### 3. Client-Side Image Service

**File:** `src/services/worksheet/WorksheetImageGenerationService.ts`

#### Main Class

```typescript
export class WorksheetImageGenerationService {
  constructor(apiKey?: string) {
    this.fluxApiKey = apiKey || process.env.NEXT_PUBLIC_FLUX_API_KEY;
  }

  async generateImagesForWorksheet(
    worksheet: ParsedWorksheet,
    onProgress?: (progress: ImageGenerationProgress) => void
  ): Promise<ImageGenerationResult>
}
```

#### Key Features

- ‚úÖ Direct Flux API calls from browser
- ‚úÖ Progress tracking with callbacks
- ‚úÖ Educational prompt enhancement
- ‚úÖ Error handling per image
- ‚úÖ Base64 image support
- ‚úÖ Dimension adjustment (multiples of 16)

#### Image Generation

```typescript
private async generateSingleImage(
  prompt: string,
  width: number,
  height: number
): Promise<string> {
  // 1. Adjust dimensions (multiples of 16)
  // 2. Enhance prompt for educational content
  // 3. Call Flux API directly
  // 4. Return base64 data URL
}
```

#### Prompt Enhancement

```typescript
private enhanceEducationalPrompt(prompt: string): string {
  // Adds:
  // - "educational content"
  // - "child-friendly"
  // - "safe for children"
  // - "bright and engaging"
  // - "professional digital art"
  // - "vibrant colors"
}
```

---

### 4. Frontend Integration

**File:** `src/components/worksheet/WorksheetEditor.tsx`

#### State Management

```typescript
const [generationStage, setGenerationStage] = useState<'content' | 'images'>('content');
const [imageProgress, setImageProgress] = useState<ImageGenerationProgress | null>(null);
```

#### Generation Flow

```typescript
const handleGenerateWorksheet = async (params: any) => {
  // STAGE 1: Content
  setGenerationStage('content');
  const response = await fetch('/api/worksheet/generate', {...});
  let finalWorksheet = data.data.worksheet;

  // STAGE 2: Images (client-side)
  if (params.includeImages) {
    setGenerationStage('images');
    const imageService = new WorksheetImageGenerationService();
    
    const result = await imageService.generateImagesForWorksheet(
      finalWorksheet,
      (progress) => setImageProgress(progress)
    );
    
    finalWorksheet = result.worksheet;
  }

  setGeneratedWorksheet(finalWorksheet);
};
```

#### Progress UI

```tsx
{generationStage === 'images' && (
  <>
    <Typography>üé® Generating Images</Typography>
    <LinearProgress 
      value={(imageProgress.completed / imageProgress.total) * 100}
    />
    <Typography>
      {imageProgress.completed} / {imageProgress.total} images
    </Typography>
  </>
)}
```

---

## üéØ Data Flow

### 1. Gemini Response (with imagePrompt)

```json
{
  "topic": "Dinosaurs",
  "pages": [
    {
      "elements": [
        {
          "type": "image-placeholder",
          "properties": {
            "imagePrompt": "A friendly T-Rex dinosaur in prehistoric forest, educational illustration for children, bright colors",
            "caption": "T-Rex Dinosaur",
            "width": 400,
            "height": 300,
            "align": "center"
          }
        }
      ]
    }
  ]
}
```

### 2. Flux API Request (from browser)

```typescript
fetch('https://api.together.xyz/v1/images/generations', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${NEXT_PUBLIC_FLUX_API_KEY}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    model: 'black-forest-labs/FLUX.1-schnell',
    prompt: enhancedPrompt,
    width: 400,
    height: 304, // Adjusted to multiple of 16
    steps: 4,
    response_format: 'b64_json',
  }),
});
```

### 3. Final Element (after generation)

```json
{
  "type": "image-placeholder",
  "properties": {
    "imagePrompt": "A friendly T-Rex dinosaur...",
    "url": "data:image/png;base64,iVBORw0KGgoAAAANS...",  ‚Üê Added by client
    "caption": "T-Rex Dinosaur",
    "width": 400,
    "height": 300,
    "align": "center"
  }
}
```

---

## üîß Configuration

### Environment Variables

```env
NEXT_PUBLIC_FLUX_API_KEY=your_flux_api_key_here
```

‚ö†Ô∏è **Important:** `NEXT_PUBLIC_` prefix exposes this to the client!

### API Configuration

```typescript
// In WorksheetImageGenerationService.ts
const response = await fetch('https://api.together.xyz/v1/images/generations', {
  // Configuration
  model: 'black-forest-labs/FLUX.1-schnell',
  steps: 4,              // Fast generation
  guidance_scale: 3.5,   // Prompt adherence
});
```

---

## üìä Progress Tracking

### Progress Interface

```typescript
interface ImageGenerationProgress {
  total: number;           // Total images to generate
  completed: number;       // Images completed
  current?: string;        // Current image caption
  errors: string[];        // Failed images
}
```

### Usage

```typescript
const result = await imageService.generateImagesForWorksheet(
  worksheet,
  (progress) => {
    console.log(`${progress.completed}/${progress.total}`);
    console.log(`Current: ${progress.current}`);
    console.log(`Errors: ${progress.errors.length}`);
  }
);
```

---

## üé® Prompt Enhancement System

### Base Prompt (from Gemini)

```
"A butterfly on a flower"
```

### Enhanced Prompt (by service)

```
"A butterfly on a flower, child-friendly, safe for children, professional digital art, vibrant colors"
```

### Enhancement Logic

```typescript
const educationalModifiers = [
  'educational content',
  'child-friendly',
  'safe for children',
  'bright and engaging',
];

const technicalModifiers = [
  'professional digital art',
  'vibrant colors',
  'sharp focus',
  'highly detailed',
];
```

---

## ‚úÖ Testing

### Test Scenario 1: With Images

```
1. Open http://localhost:3000/worksheet-editor
2. Enter topic: "Dinosaurs"
3. Enable "Include Images" ‚úÖ
4. Click Generate
5. Observe:
   - Stage 1: "‚ú® AI is Creating Your Worksheet"
   - Stage 2: "üé® Generating Images" with progress bar
6. Result: Worksheet with generated images
```

### Test Scenario 2: Without Images

```
1. Open http://localhost:3000/worksheet-editor
2. Enter topic: "Math"
3. Disable "Include Images" ‚ùå
4. Click Generate
5. Observe:
   - Only Stage 1: "‚ú® AI is Creating Your Worksheet"
6. Result: Worksheet without images
```

### Test Scenario 3: Error Handling

```
1. Remove NEXT_PUBLIC_FLUX_API_KEY
2. Try generating with images
3. Observe:
   - Progress shows errors
   - Some images fail gracefully
   - Worksheet still displays
```

---

## üöÄ Performance

### Generation Times

- **Content Generation:** 10-30 seconds (Gemini)
- **Image Generation:** 2-5 seconds per image (Flux)
- **Total:** 10-60 seconds (depending on page count and images)

### Optimization

- ‚úÖ Parallel generation not used (sequential for stability)
- ‚úÖ Fast Flux model (FLUX.1-schnell, 4 steps)
- ‚úÖ Dimension adjustment to multiples of 16
- ‚úÖ Base64 format (no file upload)

### Future Improvements

- [ ] Parallel image generation
- [ ] Image caching
- [ ] Retry failed images
- [ ] Server-side generation option
- [ ] Image optimization/compression

---

## üîí Security Considerations

### Current Implementation

‚ö†Ô∏è **API Key Exposed:** `NEXT_PUBLIC_FLUX_API_KEY` is visible in client code

### Risks

- API key can be extracted from browser
- No rate limiting on client side
- Potential abuse if discovered

### Mitigations

1. **Use for internal tools only**
2. **Monitor API usage**
3. **Set API key budget limits**
4. **Implement server-side generation** (future)

### Server-Side Alternative (Future)

```typescript
// POST /api/images/worksheet
export async function POST(request: Request) {
  // API key stays on server
  const result = await fluxApi.generate({...});
  return NextResponse.json(result);
}
```

---

## üìù Example: Complete Generation

### Input Parameters

```typescript
{
  topic: "Solar System",
  ageGroup: "8-9",
  exerciseTypes: [],           // Auto-select
  difficulty: "medium",
  language: "en",
  pageCount: 2,
  includeImages: true,         ‚Üê Images enabled
  additionalInstructions: "",
}
```

### Stage 1: Gemini Response

```json
{
  "pages": [
    {
      "elements": [
        {
          "type": "title-block",
          "properties": { "text": "Solar System" }
        },
        {
          "type": "image-placeholder",
          "properties": {
            "imagePrompt": "Solar system planets in space, colorful educational diagram",
            "caption": "The Solar System"
          }
        },
        {
          "type": "fill-blank",
          "properties": {
            "question": "Earth is the _____ planet from the Sun.",
            "correctAnswer": "third"
          }
        }
      ]
    }
  ]
}
```

### Stage 2: Client Processing

```
1. Find image-placeholder with imagePrompt ‚úì
2. Call Flux API with prompt
3. Receive base64 image
4. Update properties.url
5. Continue to next image
```

### Final Output

```json
{
  "type": "image-placeholder",
  "properties": {
    "imagePrompt": "Solar system planets in space...",
    "url": "data:image/png;base64,iVBORw0KG...",  ‚Üê Generated
    "caption": "The Solar System"
  }
}
```

---

## üêõ Troubleshooting

### Issue: No images generated

**Check:**
1. `NEXT_PUBLIC_FLUX_API_KEY` in `.env.local`
2. "Include Images" toggle enabled
3. Browser console for errors
4. Flux API status

### Issue: Some images fail

**Common causes:**
1. API rate limits
2. Invalid prompt
3. Network timeout
4. Dimension issues

**Solution:** Images fail gracefully, worksheet still renders.

### Issue: Slow generation

**Expected behavior:**
- 2-5 seconds per image is normal
- Sequential generation (not parallel)
- Larger worksheets take longer

---

## üìö Related Documentation

- [AI Worksheet Generation](./AI_WORKSHEET_GENERATION.md) - Overall system
- [Atomic Components](./ATOMIC_COMPONENTS_SYSTEM.md) - Component system
- [Step1 Parameters](./STEP1_WORKSHEET_UPDATES.md) - UI parameters

---

## üéØ Summary

‚úÖ **What we built:**
- Client-side image generation service
- Two-stage generation process
- Progress tracking UI
- Educational prompt enhancement
- Error handling

‚úÖ **How it works:**
1. Gemini generates content with imagePrompts
2. Frontend receives worksheet
3. Frontend calls Flux API directly
4. Images generated one by one
5. Progress shown to user
6. Final worksheet with images

‚úÖ **Why client-side:**
- Faster feedback
- No server load
- Direct progress tracking
- Simpler architecture (for internal tools)

‚ö†Ô∏è **Trade-off:**
- API key exposed (acceptable for internal use)
