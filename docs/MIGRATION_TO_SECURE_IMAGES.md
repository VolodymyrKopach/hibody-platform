# üîÑ –ú—ñ–≥—Ä–∞—Ü—ñ—è –Ω–∞ –±–µ–∑–ø–µ—á–Ω—É –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –∑–æ–±—Ä–∞–∂–µ–Ω—å

## –©–æ –±—É–ª–æ –∑—Ä–æ–±–ª–µ–Ω–æ (6 –∂–æ–≤—Ç–Ω—è 2025)

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –≤–∏—Ä—ñ—à–µ–Ω–∞
–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –¥–ª—è worksheet —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î –Ω–∞ **–±—É–¥—å-—è–∫–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ** (localhost, staging, production), –∞ –Ω–µ —Ç—ñ–ª—å–∫–∏ –Ω–∞ localhost.

### üîí –ë–µ–∑–ø–µ–∫–∞
API –∫–ª—é—á –±—ñ–ª—å—à–µ **–Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä**. –í—ñ–Ω –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.

---

## üìã –î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∑–º—ñ–Ω

### 1. ‚ú® –ù–æ–≤–∏–π Batch API Endpoint
**–§–∞–π–ª:** `src/app/api/worksheet/generate-images/route.ts` (–ù–û–í–ò–ô)

- –ü—Ä–∏–π–º–∞—î –º–∞—Å–∏–≤ –∑–∞–ø–∏—Ç—ñ–≤ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é –∑–æ–±—Ä–∞–∂–µ–Ω—å
- –ì–µ–Ω–µ—Ä—É—î –≤—Å—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è **–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ** –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
- –ú–∞—î –≤–±—É–¥–æ–≤–∞–Ω–∏–π **retry –º–µ—Ö–∞–Ω—ñ–∑–º** (3 —Å–ø—Ä–æ–±–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è)
- –ü–æ–≤–µ—Ä—Ç–∞—î –¥–µ—Ç–∞–ª—å–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–ü—Ä–∏–∫–ª–∞–¥ –∑–∞–ø–∏—Ç—É:**
```typescript
POST /api/worksheet/generate-images
{
  "images": [
    { "prompt": "cat", "width": 512, "height": 512 },
    { "prompt": "dog", "width": 400, "height": 300 }
  ]
}
```

### 2. üîß –û–Ω–æ–≤–ª–µ–Ω–∏–π Service
**–§–∞–π–ª:** `src/services/worksheet/WorksheetImageGenerationService.ts`

**–ó–º—ñ–Ω–µ–Ω–æ:**
- ‚ùå –í–∏–¥–∞–ª–µ–Ω–æ –ø—Ä—è–º—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ Together AI –∑ –∫–ª—ñ—î–Ω—Ç–∞
- ‚úÖ –¢–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±–µ–∑–ø–µ—á–Ω–∏–π batch API endpoint
- ‚úÖ –ó–±–∏—Ä–∞—î –≤—Å—ñ image-placeholders –∑ worksheet
- ‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –æ–¥–∏–Ω batch –∑–∞–ø–∏—Ç –∑–∞–º—ñ—Å—Ç—å –±–∞–≥–∞—Ç—å–æ—Ö –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏—Ö
- ‚úÖ –ú–∞–ø–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –Ω–∞–∑–∞–¥ –Ω–∞ worksheet pages

**API –∑–∞–ª–∏—à–∏–≤—Å—è —Ç–æ–π —Å–∞–º–∏–π:**
```typescript
const service = new WorksheetImageGenerationService();
await service.generateImagesForWorksheet(worksheet, onProgress);
```

### 3. üé® –û–Ω–æ–≤–ª–µ–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
**–§–∞–π–ª–∏:**
- `src/components/worksheet/WorksheetEditor.tsx`
- `src/components/worksheet/Step3CanvasEditor.tsx`

**–ó–º—ñ–Ω–µ–Ω–æ:**
- ‚ùå –í–∏–¥–∞–ª–µ–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `process.env.NEXT_PUBLIC_TOGETHER_API_KEY`
- ‚úÖ –ü—Ä–æ—Å—Ç–æ —Å—Ç–≤–æ—Ä—é—é—Ç—å —Å–µ—Ä–≤—ñ—Å –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤

**–ë—É–ª–æ:**
```typescript
const imageService = new WorksheetImageGenerationService(
  process.env.NEXT_PUBLIC_TOGETHER_API_KEY
);
```

**–°—Ç–∞–ª–æ:**
```typescript
const imageService = new WorksheetImageGenerationService();
```

### 4. üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
**–§–∞–π–ª–∏:**
- `docs/SECURE_IMAGE_GENERATION.md` (–ù–û–í–ò–ô) - –ø–æ–≤–Ω–∏–π –æ–ø–∏—Å —Å–∏—Å—Ç–µ–º–∏
- `docs/MIGRATION_TO_SECURE_IMAGES.md` (—Ü–µ–π —Ñ–∞–π–ª) - —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó

---

## ‚öôÔ∏è –©–æ —Ç—Ä–µ–±–∞ –∑—Ä–æ–±–∏—Ç–∏ –¥–ª—è deployment

### –ù–∞ –≤–∞—à–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ/–ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ

1. **–î–æ–¥–∞–π—Ç–µ –∑–º—ñ–Ω–Ω—É —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞:**
   ```
   TOGETHER_API_KEY=–≤–∞—à_–∫–ª—é—á_—Ç—É—Ç
   ```
   
   ‚ö†Ô∏è **–í–ê–ñ–õ–ò–í–û:** –ë–ï–ó –ø—Ä–µ—Ñ—ñ–∫—Å—É `NEXT_PUBLIC_`!

2. **–í–∏–¥–∞–ª—ñ—Ç—å —Å—Ç–∞—Ä—É –∑–º—ñ–Ω–Ω—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):**
   ```
   NEXT_PUBLIC_TOGETHER_API_KEY  # ‚ùå –ë—ñ–ª—å—à–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
   ```

### –ü—Ä–∏–∫–ª–∞–¥–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

#### Vercel
1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ Settings ‚Üí Environment Variables
2. –î–æ–¥–∞–π—Ç–µ `TOGETHER_API_KEY` –∑—ñ –∑–Ω–∞—á–µ–Ω–Ω—è–º –≤–∞—à–æ–≥–æ –∫–ª—é—á–∞
3. –û–±–µ—Ä—ñ—Ç—å –≤—Å—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (Production, Preview, Development)
4. Redeploy –ø—Ä–æ–µ–∫—Ç

#### Netlify
1. Site settings ‚Üí Environment variables
2. –î–æ–¥–∞–π—Ç–µ `TOGETHER_API_KEY`
3. Redeploy

#### Docker
```dockerfile
ENV TOGETHER_API_KEY=your_key_here
```

#### AWS / DigitalOcean / —ñ–Ω—à—ñ
–î–æ–¥–∞–π—Ç–µ –∑–º—ñ–Ω–Ω—É –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –≤–∞—à–æ–≥–æ deployment pipeline

---

## üß™ –Ø–∫ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏

### –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
# –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ TOGETHER_API_KEY —î –≤ .env.local
grep TOGETHER_API_KEY .env.local

# –ó–∞–ø—É—Å—Ç—ñ—Ç—å dev —Å–µ—Ä–≤–µ—Ä
npm run dev

# –í—ñ–¥–∫—Ä–∏–π—Ç–µ worksheet generator
open http://localhost:3000/worksheet-generator
```

### –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ:
1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –≤–∞—à worksheet generator
2. –°—Ç–≤–æ—Ä—ñ—Ç—å worksheet –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º–∏
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ - –Ω–µ –ø–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ –ø–æ–º–∏–ª–æ–∫ –ø—Ä–æ API key
4. –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤–∏–Ω–Ω—ñ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏—Å—å —ñ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏—Å—å

---

## üéØ –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏

| –ê—Å–ø–µ–∫—Ç | –°—Ç–∞—Ä–∏–π –ø—ñ–¥—Ö—ñ–¥ | –ù–æ–≤–∏–π –ø—ñ–¥—Ö—ñ–¥ |
|--------|---------------|--------------|
| **–ë–µ–∑–ø–µ–∫–∞** | ‚ùå API key –≤ –±—Ä–∞—É–∑–µ—Ä—ñ | ‚úÖ API key —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ |
| **–ü—Ä–æ–¥–∞–∫—à–Ω** | ‚ùå –ù–µ –ø—Ä–∞—Ü—é–≤–∞–ª–æ | ‚úÖ –ü—Ä–∞—Ü—é—î —Å–∫—Ä—ñ–∑—å |
| **–®–≤–∏–¥–∫—ñ—Å—Ç—å** | ‚ö†Ô∏è –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è | ‚úÖ –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ batch –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è |
| **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å** | ‚ö†Ô∏è –ë–µ–∑ retry | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π retry (3√ó) |
| **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥** | ‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–∏–π | ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |

---

## üêõ Troubleshooting

### "API key not configured"
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ .env.local
cat .env.local | grep TOGETHER_API_KEY

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä
npm run dev
```

### "Batch API error: 500"
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ–º–∏–ª–∫–∏. –ú–æ–∂–ª–∏–≤–æ:
- API –∫–ª—é—á –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π
- –î–æ—Å—è–≥–Ω—É—Ç–æ –ª—ñ–º—ñ—Ç Together AI
- –ü—Ä–æ–±–ª–µ–º–∏ –∑ –º–µ—Ä–µ–∂–µ—é

### –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –Ω–µ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Network tab –≤ DevTools
2. –®—É–∫–∞–π—Ç–µ –∑–∞–ø–∏—Ç–∏ –¥–æ `/api/worksheet/generate-images`
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ response - —Ç–∞–º –±—É–¥–µ –¥–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏

---

## üìä –û—á—ñ–∫—É–≤–∞–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

**4 –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (512√ó512):**
- –°—Ç–∞—Ä–∏–π: ~20-30 —Å–µ–∫—É–Ω–¥ (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ)
- **–ù–æ–≤–∏–π: ~5-8 —Å–µ–∫—É–Ω–¥** (–ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ) ‚ö°

**10 –∑–æ–±—Ä–∞–∂–µ–Ω—å:**
- –°—Ç–∞—Ä–∏–π: ~50-60 —Å–µ–∫—É–Ω–¥
- **–ù–æ–≤–∏–π: ~12-15 —Å–µ–∫—É–Ω–¥** ‚ö°

---

## ‚úÖ Checklist –¥–ª—è deployment

- [ ] –î–æ–¥–∞–Ω–æ `TOGETHER_API_KEY` –≤ environment variables
- [ ] –í–∏–¥–∞–ª–µ–Ω–æ –∞–±–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ `NEXT_PUBLIC_TOGETHER_API_KEY`
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ/redeployed –¥–æ–¥–∞—Ç–æ–∫
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–æ–≤–∞–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é worksheet –∑ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è–º–∏
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (–±–µ–∑ –ø–æ–º–∏–ª–æ–∫)
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (—É—Å–ø—ñ—à–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è)

---

## üöÄ –ì–æ—Ç–æ–≤–æ –¥–æ production!

–¢–µ–ø–µ—Ä –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–æ–±—Ä–∞–∂–µ–Ω—å:
- ‚úÖ –ü–æ–≤–Ω—ñ—Å—Ç—é –±–µ–∑–ø–µ—á–Ω–∞
- ‚úÖ –ü—Ä–∞—Ü—é—î –Ω–∞ –±—É–¥—å-—è–∫–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ
- ‚úÖ –®–≤–∏–¥—à–∞ –∑–∞–≤–¥—è–∫–∏ batch processing
- ‚úÖ –ù–∞–¥—ñ–π–Ω—ñ—à–∞ –∑–∞–≤–¥—è–∫–∏ retry –º–µ—Ö–∞–Ω—ñ–∑–º—É
- ‚úÖ Production-ready

---

**–î–∞—Ç–∞ –º—ñ–≥—Ä–∞—Ü—ñ—ó:** 6 –∂–æ–≤—Ç–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:** ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ
